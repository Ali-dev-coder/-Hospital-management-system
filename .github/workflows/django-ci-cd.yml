name: Django CI/CD to PythonAnywhere

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2️⃣ Set up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # 3️⃣ Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r req.txt

    # 4️⃣ Run Django migrations (locally if needed for tests)
    - name: Run migrations
      run: |
        python manage.py migrate

    # 5️⃣ Deploy to PythonAnywhere via SSH
    - name: Deploy to PythonAnywhere
      env:
        PA_USERNAME: ${{ secrets.PA_USERNAME }}
        PA_SSH_KEY: ${{ secrets.PA_SSH_KEY }}   # Private SSH key added to GitHub secrets
      run: |
        # mkdir -p ~/.ssh
        # echo "$PA_SSH_KEY" > ~/.ssh/id_rsa
        # chmod 600 ~/.ssh/id_rsa

        # ssh -o StrictHostKeyChecking=no $PA_USERNAME@ssh.pythonanywhere.com "
        #   # cd ~/Hospital-management-system &&    # <-- Replace with your project folder on PA
          git pull &&
          python3.10 -m pip install -r req.txt &&
          python3.10 manage.py migrate &&
          pa_reload_webapp $PA_USERNAME.pythonanywhere.com
        "
